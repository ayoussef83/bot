generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model attributions {
  id             String        @id
  conversationId String
  campaignId     String?
  source         String?
  medium         String?
  campaignName   String?
  content        String?
  term           String?
  firstTouchAt   DateTime      @default(now())
  lastTouchAt    DateTime      @default(now())
  touchpoints    Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  campaigns      campaigns?    @relation(fields: [campaignId], references: [id])
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([conversationId])
  @@index([source, medium])
}

model audit_logs {
  id         String      @id
  userId     String?
  action     AuditAction
  entityType String
  entityId   String?
  changes    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([userId])
}

model bank_sync_runs {
  id            String         @id
  cashAccountId String
  source        BankSyncSource
  asOfDate      DateTime
  endingBalance Float
  fileName      String?
  rowCount      Int?
  notes         String?
  createdBy     String?
  createdAt     DateTime       @default(now())
  cash_accounts cash_accounts  @relation(fields: [cashAccountId], references: [id])

  @@index([asOfDate])
  @@index([cashAccountId])
}

model campaigns {
  id               String           @id
  name             String
  description      String?
  type             CampaignType
  status           CampaignStatus   @default(active)
  startDate        DateTime
  endDate          DateTime?
  budget           Float?
  channelAccountId String
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  utmTerm          String?
  utmContent       String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  spend            Float?           @default(0)
  attributions     attributions[]
  channel_accounts channel_accounts @relation(fields: [channelAccountId], references: [id])
  conversations    conversations[]

  @@index([channelAccountId])
  @@index([status, startDate])
}

model cash_accounts {
  id             String           @id
  name           String
  type           CashAccountType
  accountNumber  String?
  bankName       String?
  balance        Float            @default(0)
  currency       String           @default("EGP")
  isActive       Boolean          @default(true)
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  bank_sync_runs bank_sync_runs[]
  expenses       expenses[]
  payments       payments[]

  @@index([isActive])
  @@index([type])
}

model channel_accounts {
  id            String               @id
  platform      MarketingPlatform
  externalId    String
  name          String
  accessToken   String
  refreshToken  String?
  status        ChannelAccountStatus @default(connected)
  connectedAt   DateTime             @default(now())
  lastSyncAt    DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime
  settings      Json?
  campaigns     campaigns[]
  conversations conversations[]

  @@unique([platform, externalId])
  @@index([platform, status])
}

model classes {
  id                    String                @id
  name                  String
  capacity              Int
  instructorId          String?
  dayOfWeek             Int
  startTime             String
  endTime               String
  startDate             DateTime
  endDate               DateTime?
  customData            Json?
  avgStudentsPerSession Float?                @default(0)
  utilizationPercentage Float?                @default(0)
  isUnderfilled         Boolean               @default(false)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime
  deletedAt             DateTime?
  courseLevelId         String?
  locationName          String?
  location              Location
  course_levels         course_levels?        @relation(fields: [courseLevelId], references: [id])
  instructors           instructors?          @relation(fields: [instructorId], references: [id])
  sessions              sessions[]
  student_enrollments   student_enrollments[]
  students              students[]

  @@index([instructorId])
  @@index([location])
}

model conversations {
  id                 String               @id
  platform           MarketingPlatform
  status             ConversationStatus   @default(new)
  channelAccountId   String
  participantId      String
  campaignId         String?
  assignedTo         String?
  lastMessageAt      DateTime             @default(now())
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  externalThreadId   String
  firstMessageAt     DateTime             @default(now())
  lastReadAt         DateTime?
  leadId             String?
  metadata           Json?
  source             String?
  attributions       attributions[]
  campaigns          campaigns?           @relation(fields: [campaignId], references: [id])
  channel_accounts   channel_accounts     @relation(fields: [channelAccountId], references: [id])
  participants       participants         @relation(fields: [participantId], references: [id])
  leads              leads?
  marketing_messages marketing_messages[]

  @@unique([platform, externalThreadId])
  @@index([assignedTo])
  @@index([campaignId])
  @@index([channelAccountId])
  @@index([leadId])
  @@index([participantId])
  @@index([status, lastMessageAt])
}

model course_levels {
  id                  String                @id
  courseId            String
  name                String
  sortOrder           Int                   @default(1)
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  deletedAt           DateTime?
  classes             classes[]
  courses             courses               @relation(fields: [courseId], references: [id])
  student_enrollments student_enrollments[]

  @@unique([courseId, name])
  @@index([courseId])
  @@index([isActive])
}

model courses {
  id            String          @id
  name          String          @unique
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  deletedAt     DateTime?
  course_levels course_levels[]

  @@index([isActive])
}

model custom_field_definitions {
  id        String            @id
  entity    CustomFieldEntity
  key       String
  label     String
  type      CustomFieldType
  required  Boolean           @default(false)
  options   Json?
  order     Int               @default(0)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime
  deletedAt DateTime?
  createdBy String?

  @@unique([entity, key])
  @@index([entity, isActive])
}

model expense_categories {
  id          String     @id
  name        String
  code        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  expenses    expenses[]

  @@index([isActive])
}

model expenses {
  id                 String             @id
  expenseNumber      String             @unique
  expenseDate        DateTime
  paidDate           DateTime?
  amount             Float
  categoryId         String
  vendor             String?
  description        String
  cashAccountId      String?
  status             ExpenseStatus      @default(draft)
  approvedBy         String?
  approvedAt         DateTime?
  instructorId       String?
  periodId           String?
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  paidBy             String?
  receiptUrl         String?
  sessionId          String?
  paymentMethod      PaymentMethod?
  cash_accounts      cash_accounts?     @relation(fields: [cashAccountId], references: [id])
  expense_categories expense_categories @relation(fields: [categoryId], references: [id])
  instructors        instructors?       @relation(fields: [instructorId], references: [id])
  financial_periods  financial_periods? @relation(fields: [periodId], references: [id])

  @@index([categoryId])
  @@index([expenseDate])
  @@index([expenseNumber])
  @@index([instructorId])
  @@index([periodId])
  @@index([status])
}

model financial_periods {
  id                     String                   @id
  periodCode             String                   @unique
  startDate              DateTime
  endDate                DateTime
  status                 FinancialPeriodStatus    @default(open)
  closedAt               DateTime?
  closedBy               String?
  lockedAt               DateTime?
  lockedBy               String?
  notes                  String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  expenses               expenses[]
  reconciliation_records reconciliation_records[]

  @@index([periodCode])
  @@index([status])
}

model instructors {
  id         String             @id
  userId     String             @unique
  costType   InstructorCostType
  costAmount Float
  createdAt  DateTime           @default(now())
  updatedAt  DateTime
  deletedAt  DateTime?
  classes    classes[]
  expenses   expenses[]
  users      users              @relation(fields: [userId], references: [id])
  sessions   sessions[]
}

model integration_configs {
  id        String              @id
  provider  IntegrationProvider @unique
  isActive  Boolean             @default(true)
  config    Json?
  createdAt DateTime            @default(now())
  updatedAt DateTime
  secrets   Json?
}

model invoices {
  id                  String                @id
  invoiceNumber       String                @unique
  studentId           String?
  classId             String?
  subscriptionId      String?
  issueDate           DateTime              @default(now())
  dueDate             DateTime
  subtotal            Float                 @default(0)
  discountAmount      Float                 @default(0)
  taxAmount           Float                 @default(0)
  totalAmount         Float
  status              InvoiceStatus         @default(issued)
  installmentPlanId   String?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  students            students?             @relation(fields: [studentId], references: [id])
  payment_allocations payment_allocations[]

  @@index([dueDate])
  @@index([invoiceNumber])
  @@index([status])
  @@index([studentId])
}

model lead_follow_ups {
  id             String    @id
  leadId         String
  notes          String
  nextAction     String?
  nextActionDate DateTime?
  createdAt      DateTime  @default(now())
  createdBy      String?
  leads          leads     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

model leads {
  id                      String            @id
  firstName               String
  lastName                String
  email                   String?
  phone                   String
  source                  LeadSource
  status                  LeadStatus        @default(new)
  notes                   String?
  interestedIn            LearningTrack?
  customData              Json?
  convertedToStudentId    String?
  convertedAt             DateTime?
  marketingConversationId String?           @unique
  marketingParticipantId  String?           @unique
  marketingCampaignId     String?
  marketingSource         String?
  marketingMedium         String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  deletedAt               DateTime?
  createdBy               String?
  convertedToParentId     String?
  lead_follow_ups         lead_follow_ups[]
  parents                 parents?          @relation(fields: [convertedToParentId], references: [id])
  conversations           conversations?    @relation(fields: [marketingConversationId], references: [id])
  participants            participants?     @relation(fields: [marketingParticipantId], references: [id])

  @@index([convertedToParentId])
  @@index([phone])
  @@index([source])
  @@index([status])
}

model marketing_messages {
  id                String           @id
  conversationId    String
  externalMessageId String
  direction         MessageDirection
  type              MessageType      @default(text)
  content           String?
  mediaUrl          String?
  sentAt            DateTime         @default(now())
  deliveredAt       DateTime?
  readAt            DateTime?
  senderId          String?
  metadata          Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  conversations     conversations    @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, sentAt])
  @@index([direction, sentAt])
  @@index([externalMessageId])
}

model message_templates {
  id        String         @id
  channel   MessageChannel
  key       String
  name      String
  subject   String?
  body      String
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime
  deletedAt DateTime?
  createdBy String?

  @@unique([channel, key])
  @@index([channel, isActive])
}

model monthly_snapshots {
  id                    String   @id
  year                  Int
  month                 Int
  totalRevenue          Float    @default(0)
  subscriptionRevenue   Float    @default(0)
  campRevenue           Float    @default(0)
  b2bRevenue            Float    @default(0)
  totalExpenses         Float    @default(0)
  rentExpenses          Float    @default(0)
  instructorExpenses    Float    @default(0)
  marketingExpenses     Float    @default(0)
  operationsExpenses    Float    @default(0)
  activeStudents        Int      @default(0)
  avgStudentsPerSession Float    @default(0)
  instructorUtilization Float    @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@unique([year, month])
  @@index([year, month])
}

model notifications {
  id           String              @id
  channel      NotificationChannel
  recipient    String
  template     String?
  subject      String?
  message      String
  payload      String?
  status       NotificationStatus  @default(pending)
  sentAt       DateTime?
  errorMessage String?
  scheduledAt  DateTime?
  studentId    String?
  leadId       String?
  parentId     String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime

  @@index([channel])
  @@index([leadId])
  @@index([scheduledAt])
  @@index([status])
  @@index([studentId])
}

model parents {
  id        String     @id
  firstName String
  lastName  String
  email     String?
  phone     String
  createdAt DateTime   @default(now())
  updatedAt DateTime
  deletedAt DateTime?
  address   String?
  userId    String?    @unique
  leads     leads[]
  users     users?     @relation(fields: [userId], references: [id])
  students  students[]

  @@index([phone])
}

model participants {
  id                String          @id
  name              String?
  phone             String?
  email             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  firstSeenAt       DateTime        @default(now())
  lastSeenAt        DateTime        @default(now())
  leadId            String?
  platformUserId    String?
  profilePictureUrl String?
  type              ParticipantType @default(unknown)
  conversations     conversations[]
  leads             leads?

  @@index([email])
  @@index([phone])
  @@index([platformUserId])
  @@index([type, leadId])
}

model payment_allocations {
  id          String   @id
  paymentId   String
  invoiceId   String
  amount      Float
  allocatedAt DateTime @default(now())
  allocatedBy String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  invoices    invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payments    payments @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentId])
}

model payments {
  id                  String                @id
  paymentNumber       String                @unique
  receivedDate        DateTime              @default(now())
  amount              Float
  method              PaymentMethod
  cashAccountId       String
  referenceNumber     String?
  receivedBy          String?
  status              PaymentStatus         @default(received)
  reversedAt          DateTime?
  reversalReason      String?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  studentId           String?
  payment_allocations payment_allocations[]
  cash_accounts       cash_accounts         @relation(fields: [cashAccountId], references: [id])
  students            students?             @relation(fields: [studentId], references: [id])

  @@index([cashAccountId])
  @@index([paymentNumber])
  @@index([receivedDate])
  @@index([status])
}

model reconciliation_records {
  id                   String             @id
  reconciliationNumber String             @unique
  periodId             String
  reconciliationDate   DateTime
  type                 ReconciliationType
  amount               Float
  description          String
  reconciledBy         String?
  approvedBy           String?
  approvedAt           DateTime?
  relatedInvoiceId     String?
  relatedPaymentId     String?
  relatedExpenseId     String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  notes                String?
  financial_periods    financial_periods  @relation(fields: [periodId], references: [id])

  @@index([periodId])
  @@index([reconciliationDate])
  @@index([reconciliationNumber])
  @@index([type])
}

model session_attendances {
  id        String   @id
  sessionId String
  studentId String
  attended  Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  sessions  sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  students  students @relation(fields: [studentId], references: [id])

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
}

model sessions {
  id                  String                @id
  classId             String
  scheduledDate       DateTime
  startTime           DateTime
  endTime             DateTime
  instructorId        String?
  status              String                @default("scheduled")
  instructorConfirmed Boolean               @default(false)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  deletedAt           DateTime?
  notes               String?
  room                String?
  session_attendances session_attendances[]
  classes             classes               @relation(fields: [classId], references: [id])
  instructors         instructors?          @relation(fields: [instructorId], references: [id])

  @@index([classId])
  @@index([instructorId])
  @@index([scheduledDate])
}

model student_enrollments {
  id            String        @id
  studentId     String
  courseLevelId String
  classId       String?
  status        String        @default("active")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  classes       classes?      @relation(fields: [classId], references: [id])
  course_levels course_levels @relation(fields: [courseLevelId], references: [id])
  students      students      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseLevelId])
  @@index([classId])
  @@index([courseLevelId])
  @@index([studentId])
}

model students {
  id                  String                @id
  userId              String?               @unique
  firstName           String
  lastName            String
  age                 Int
  learningTrack       LearningTrack
  status              StudentStatus         @default(active)
  email               String?
  phone               String?
  parentId            String?
  classId             String?
  customData          Json?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  deletedAt           DateTime?
  invoices            invoices[]
  payments            payments[]
  session_attendances session_attendances[]
  student_enrollments student_enrollments[]
  classes             classes?              @relation(fields: [classId], references: [id])
  parents             parents?              @relation(fields: [parentId], references: [id])
  users               users?                @relation(fields: [userId], references: [id])

  @@index([classId])
  @@index([parentId])
  @@index([status])
}

model users {
  id          String       @id
  email       String       @unique
  password    String
  firstName   String
  lastName    String
  role        UserRole
  status      UserStatus   @default(active)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  instructors instructors?
  parents     parents?
  students    students?

  @@index([email])
  @@index([role])
}

enum AuditAction {
  create
  update
  delete
  view
  login
  logout
}

enum BankSyncSource {
  manual
  csv_upload
}

enum CampaignStatus {
  active
  paused
  completed
}

enum CampaignType {
  organic_post
  paid_ad
  story
  reel
  whatsapp_broadcast
}

enum CashAccountType {
  bank
  cash
  wallet
}

enum ChannelAccountStatus {
  connected
  disconnected
  error
}

enum ConversationStatus {
  new
  in_progress
  waiting_reply
  converted
  archived
}

enum CustomFieldEntity {
  student
  class
  payment
  lead
}

enum CustomFieldType {
  text
  number
  boolean
  date
  select
}

enum ExpenseCategoryType {
  instructor_payouts
  rent
  marketing
  utilities
  operations
  other
}

enum ExpenseStatus {
  draft
  pending_approval
  approved
  paid
  reversed
}

enum FinancialPeriodStatus {
  open
  closed
  locked
}

enum InstructorCostType {
  hourly
  monthly
}

enum IntegrationProvider {
  zoho_email
  smsmisr
}

enum InvoiceStatus {
  draft
  issued
  partially_paid
  paid
  overdue
  cancelled
}

enum LeadSource {
  website
  referral
  social_media
  event
  walk_in
  other
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  lost
}

enum LearningTrack {
  AI
  robotics
  coding
  general
}

enum Location {
  MOA
  Espace
  SODIC
  PalmHills
}

enum MarketingPlatform {
  facebook_page
  instagram_business
  whatsapp_business
}

enum MessageChannel {
  email
  sms
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageType {
  text
  image
  video
  audio
  file
  sticker
  location
}

enum NotificationChannel {
  email
  sms
  whatsapp
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum ParticipantType {
  unknown
  lead
  parent
  school
}

enum PaymentMethod {
  cash
  bank_transfer
  vodafone_cash
  instapay
  pos
}

enum PaymentStatus {
  pending
  received
  reversed
  failed
}

enum ReconciliationType {
  adjustment
  correction
  write_off
  reversal
}

enum StudentStatus {
  active
  paused
  finished
}

enum UserRole {
  super_admin
  management
  operations
  accounting
  sales
  instructor
  student
  parent
  school_admin
}

enum UserStatus {
  active
  inactive
  suspended
}
